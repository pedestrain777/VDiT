# EDEN è§†é¢‘æ’å¸§è¯¦ç»†ä½¿ç”¨è¯´æ˜

## ğŸ“– ä¸€ã€æ’å¸§æ•°é‡åˆ¤æ–­æœºåˆ¶

### 1.1 è¿åŠ¨åˆ†æ•°è®¡ç®—

é¡¹ç›®ä½¿ç”¨ `compute_motion_scores()` å‡½æ•°ä¸ºæ¯ä¸ªç›¸é‚»å¸§å¯¹è®¡ç®—è¿åŠ¨åˆ†æ•°ï¼ˆ0~1ï¼Œè¶Šå¤§è¡¨ç¤ºè¿åŠ¨è¶Šå‰§çƒˆï¼‰ï¼š

```135:196:inference.py
def compute_motion_scores(video_frames, topk_ratio=0.1):
    """
    è®¡ç®—å½“å‰è§†é¢‘ä¸­æ¯ä¸€å¯¹ç›¸é‚»å¸§çš„è¿åŠ¨åˆ†æ•°ï¼ˆ0~1ï¼Œè¶Šå¤§è¶ŠåŠ¨ï¼‰ã€‚

    Args:
        video_frames: [T, 3, H, W] çš„å¼ é‡ï¼Œå·²ç»æ˜¯ float ä¸”å½’ä¸€åŒ–åˆ° [0,1]
        topk_ratio: è®¡ç®—å±€éƒ¨è¿åŠ¨æ—¶é€‰å–çš„ top-k åƒç´ æ¯”ä¾‹

    Returns:
        motion_scores: é•¿åº¦ä¸º T-1 çš„ listï¼Œæ¯ä¸ªå…ƒç´  âˆˆ [0,1]
    """
    # ... è®¡ç®—è¿‡ç¨‹ ...
    # 1) å…¨å±€cosineç›¸ä¼¼åº¦ï¼ˆæ ‡å‡†åŒ–ï¼‰
    # 2) å±€éƒ¨top-kåƒç´ å·®ï¼ˆæ ‡å‡†åŒ–ï¼‰
    # 3) èåˆï¼šalpha * å…¨å±€ + (1-alpha) * å±€éƒ¨
    return motion_scores.tolist()
```

**è®¡ç®—æµç¨‹ï¼š**
1. **å…¨å±€è¿åŠ¨**ï¼šè®¡ç®—ç›¸é‚»å¸§çš„cosineç›¸ä¼¼åº¦ï¼Œåœ¨è§†é¢‘å†…æ ‡å‡†åŒ–ï¼ˆè¶Šå°è¶ŠåŠ¨ï¼‰
2. **å±€éƒ¨è¿åŠ¨**ï¼šé€‰å–top-kï¼ˆé»˜è®¤10%ï¼‰å˜åŒ–æœ€å¤§çš„åƒç´ ï¼Œè®¡ç®—å¹³å‡å·®
3. **èåˆ**ï¼š`motion_score = 0.5 * å…¨å±€è¿åŠ¨ + 0.5 * å±€éƒ¨è¿åŠ¨`

### 1.2 æ·±åº¦ï¼ˆDepthï¼‰åˆ¤æ–­

æ ¹æ®è¿åŠ¨åˆ†æ•°ä¸­ä½æ•°å°†å¸§å¯¹åˆ†ä¸ºä¸¤æ¡£ï¼š

```321:333:inference.py
    if motion_arr.max() - motion_arr.min() < 1e-6:
        # æ‰€æœ‰åŒºæ®µè¿åŠ¨å·®ä¸å¤šï¼šç»Ÿä¸€æ’ 1 å¸§
        depths = [1] * (frames_num - 1)
    else:
        # ç”¨ä¸­ä½æ•°æŠŠåŒºæ®µåˆ‡æˆä¸¤æ¡£ï¼šä½/é«˜ è¿åŠ¨
        mid_th = float(np.quantile(motion_arr, 0.5))
        depths = []
        for s in motion_scores:
            if s >= mid_th:
                depth = 2    # é«˜è¿åŠ¨ï¼šæ’ 3 å¸§
            else:
                depth = 1    # ä½/ä¸­è¿åŠ¨ï¼šæ’ 1 å¸§
            depths.append(depth)
```

**åˆ¤æ–­è§„åˆ™ï¼š**
- **depth = 1**ï¼šè¿åŠ¨åˆ†æ•° < ä¸­ä½æ•° â†’ **æ’ 1 å¸§**ï¼ˆä½/ä¸­è¿åŠ¨ï¼‰
- **depth = 2**ï¼šè¿åŠ¨åˆ†æ•° â‰¥ ä¸­ä½æ•° â†’ **æ’ 3 å¸§**ï¼ˆé«˜è¿åŠ¨ï¼‰
- å¦‚æœæ‰€æœ‰è¿åŠ¨åˆ†æ•°ç›¸åŒ â†’ ç»Ÿä¸€æ’ 1 å¸§

### 1.3 é€’å½’æ’å¸§å®ç°

```199:223:inference.py
def recursive_interp(frame0, frame1, depth, use_split_gpu=False):
    """
    é€’å½’æ’å¸§ï¼š
        depth = 0 -> ä¸æ’å¸§ï¼Œè¿”å› []
        depth = 1 -> æ’ 1 å¸§ï¼ˆä¸­ç‚¹ï¼‰ï¼Œè¿”å› [M]
        depth = 2 -> æ’ 3 å¸§ï¼ˆM0, M, M1ï¼‰
    ä»ç„¶å¤ç”¨ interpolate()ï¼Œå…¼å®¹å•/åŒ GPU æ¨¡å¼ã€‚
    """
    if depth == 0:
        return []

    # å…ˆç®—ä¸­ç‚¹
    mid = interpolate(frame0, frame1, use_split_gpu=use_split_gpu)

    if depth == 1:
        return [mid]

    # depth >= 2: å¯¹ä¸¤ä¾§å†å„æ’ä¸€å±‚
    left_mids = recursive_interp(
        frame0, mid, depth - 1, use_split_gpu=use_split_gpu
    )
    right_mids = recursive_interp(
        mid, frame1, depth - 1, use_split_gpu=use_split_gpu
    )
    return left_mids + [mid] + right_mids
```

**æ’å¸§ç»“æœï¼š**
- `depth = 1`ï¼š`[M]` â†’ è¾“å‡ºåºåˆ—ï¼š`F0, M, F1`ï¼ˆæ€»å…±3å¸§ï¼‰
- `depth = 2`ï¼š`[M0, M, M1]` â†’ è¾“å‡ºåºåˆ—ï¼š`F0, M0, M, M1, F1`ï¼ˆæ€»å…±5å¸§ï¼‰

---

## ğŸš€ äºŒã€è¿è¡Œè§†é¢‘æ’å¸§çš„æ‰€æœ‰å‘½ä»¤

### 2.1 ä½¿ç”¨ inference.pyï¼ˆæ¨è - æœ¬åœ°ç›´æ¥è¿è¡Œï¼‰

#### **åŸºç¡€å‘½ä»¤ - å•GPUæ¨¡å¼**

```bash
# æ ‡å‡†è§†é¢‘æ’å¸§ï¼ˆè‡ªé€‚åº”æ’å¸§ï¼‰
python inference.py --video_path examples/0.mp4 --interpolated_results_dir interpolation_outputs

# æŒ‡å®šé…ç½®æ–‡ä»¶
python inference.py --video_path examples/0.mp4 --config configs/eval_eden.yaml --interpolated_results_dir interpolation_outputs

# è‡ªå®šä¹‰è¾“å‡ºç›®å½•
python inference.py --video_path path/to/your/video.mp4 --interpolated_results_dir my_output
```

#### **åŒGPUæ¨¡å¼ï¼ˆåŠ é€Ÿ - éœ€è¦2å¼ ä»¥ä¸ŠGPUï¼‰**

```bash
# ä½¿ç”¨åŒGPUæ¨¡å¼ï¼šencoderåœ¨cuda:0ï¼ŒDiT+decoderåœ¨cuda:1
python inference.py --video_path examples/0.mp4 --use_split_gpu --interpolated_results_dir interpolation_outputs
```

#### **å®Œæ•´å‚æ•°è¯´æ˜**

```bash
python inference.py \
    --config configs/eval_eden.yaml \          # é…ç½®æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼šconfigs/eval_eden.yamlï¼‰
    --video_path path/to/video.mp4 \           # è¾“å…¥è§†é¢‘è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
    --interpolated_results_dir output_dir \    # è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼šinterpolation_outputsï¼‰
    --use_split_gpu                            # å¯é€‰ï¼šä½¿ç”¨åŒGPUæ¨¡å¼
```

**è¾“å‡ºï¼š**
- è§†é¢‘æ–‡ä»¶ï¼š`{interpolated_results_dir}/interpolated.mp4`
- è‡ªåŠ¨è®¡ç®—æ–°fpsä»¥ä¿æŒæ€»æ—¶é•¿ä¸å˜

---

### 2.2 ä½¿ç”¨ client.pyï¼ˆHTTPæœåŠ¡æ¨¡å¼ï¼‰

éœ€è¦å…ˆå¯åŠ¨HTTPæœåŠ¡å™¨ï¼ˆå‚è€ƒ `cloud_server/main.py` å’Œ `edge_server/main.py`ï¼‰ã€‚

#### **è‡ªé€‚åº”æ’å¸§æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**

```bash
# ä½¿ç”¨è‡ªé€‚åº”æ’å¸§ï¼ˆæ ¹æ®è¿åŠ¨åˆ†æ•°åŠ¨æ€å†³å®šæ’1å¸§æˆ–3å¸§ï¼‰
python client.py \
    --video_path examples/0.mp4 \
    --encoder_url http://127.0.0.1:8000/encode \
    --ditdec_url http://127.0.0.1:8001/interpolate \
    --output_dir interpolation_outputs/http_client \
    --use_adaptive
```

#### **å›ºå®šæ’å¸§æ¨¡å¼ï¼ˆæ¯å¯¹å¸§ä¹‹é—´å›ºå®šæ’1å¸§ï¼‰**

```bash
# ä¸ä½¿ç”¨ --use_adaptiveï¼Œåˆ™å›ºå®šæ¯å¯¹å¸§ä¹‹é—´æ’1å¸§
python client.py \
    --video_path examples/0.mp4 \
    --encoder_url http://127.0.0.1:8000/encode \
    --ditdec_url http://127.0.0.1:8001/interpolate \
    --output_dir interpolation_outputs/http_client
```

#### **å®Œæ•´å‚æ•°è¯´æ˜**

```bash
python client.py \
    --encoder_url http://127.0.0.1:8000/encode \        # EncoderæœåŠ¡URLï¼ˆé»˜è®¤ï¼‰
    --ditdec_url http://127.0.0.1:8001/interpolate \    # DiT+DecoderæœåŠ¡URLï¼ˆé»˜è®¤ï¼‰
    --video_path path/to/video.mp4 \                    # è¾“å…¥è§†é¢‘è·¯å¾„ï¼ˆå¿…éœ€ï¼‰
    --output_dir interpolation_outputs/http_client \     # è¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ï¼‰
    --use_adaptive                                       # å¯é€‰ï¼šä½¿ç”¨è‡ªé€‚åº”æ’å¸§
```

**è¾“å‡ºï¼š**
- è§†é¢‘æ–‡ä»¶ï¼š`{output_dir}/interpolated_http.mp4`

---

## ğŸ“Š ä¸‰ã€æ’å¸§é€»è¾‘è¯¦è§£

### 3.1 å®Œæ•´æµç¨‹

```python
# 1. è¯»å–è§†é¢‘
video_frames = load_video(video_path)  # [T, 3, H, W]

# 2. è®¡ç®—æ¯å¯¹ç›¸é‚»å¸§çš„è¿åŠ¨åˆ†æ•°
motion_scores = compute_motion_scores(video_frames)  # [T-1]

# 3. æ ¹æ®ä¸­ä½æ•°åˆ¤æ–­depth
mid_th = np.median(motion_scores)
depths = [2 if s >= mid_th else 1 for s in motion_scores]

# 4. é€’å½’æ’å¸§
interpolated_video = []
for i in range(T-1):
    frame0 = video_frames[i]
    frame1 = video_frames[i+1]
    depth = depths[i]
    
    interpolated_video.append(frame0)  # åŸå§‹å¸§0
    mids = recursive_interp(frame0, frame1, depth)  # é€’å½’æ’å¸§
    interpolated_video.extend(mids)    # æ’å…¥ä¸­é—´å¸§
    
interpolated_video.append(video_frames[-1])  # æœ€åä¸€å¸§

# 5. è®¡ç®—æ–°fpså¹¶ä¿å­˜
fps_out = fps * (len(interpolated_video) - 1) / (T - 1)
save_video(interpolated_video, fps_out)
```

### 3.2 è¿åŠ¨åˆ†æ•°è¾“å‡ºç¤ºä¾‹

è¿è¡Œæ—¶ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š

```
Computing motion scores for each frame interval...
Motion score stats: min=0.0101, max=0.9914, mean=0.3641
Depth distribution (1/2): 24 24
Original frames: 49, New frames: 145, fps_out â‰ˆ 24.0000
```

**è¯´æ˜ï¼š**
- `Motion score stats`ï¼šè¿åŠ¨åˆ†æ•°çš„æœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼
- `Depth distribution (1/2)`ï¼šdepth=1çš„å¸§å¯¹æ•°ï¼Œdepth=2çš„å¸§å¯¹æ•°
- `Original frames: X, New frames: Y`ï¼šåŸå§‹å¸§æ•°å’Œæ’å¸§åçš„æ€»å¸§æ•°

---

## ğŸ”§ å››ã€æ‰€æœ‰å¯ç”¨å‘½ä»¤æ±‡æ€»

### **inference.py å‘½ä»¤**

```bash
# 1. åŸºç¡€è§†é¢‘æ’å¸§ï¼ˆå•GPUï¼‰
python inference.py --video_path examples/0.mp4

# 2. è‡ªå®šä¹‰è¾“å‡ºç›®å½•
python inference.py --video_path examples/0.mp4 --interpolated_results_dir my_output

# 3. ä½¿ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
python inference.py --video_path examples/0.mp4 --config configs/eval_eden.yaml

# 4. åŒGPUæ¨¡å¼ï¼ˆencoderåœ¨cuda:0ï¼ŒDiT+decoderåœ¨cuda:1ï¼‰
python inference.py --video_path examples/0.mp4 --use_split_gpu

# 5. ç»„åˆä½¿ç”¨ï¼ˆåŒGPU + è‡ªå®šä¹‰è¾“å‡ºï¼‰
python inference.py --video_path examples/0.mp4 --use_split_gpu --interpolated_results_dir gpu_output
```

### **client.py å‘½ä»¤ï¼ˆéœ€è¦HTTPæœåŠ¡ï¼‰**

```bash
# 1. è‡ªé€‚åº”æ’å¸§æ¨¡å¼ï¼ˆæ¨èï¼‰
python client.py --video_path examples/0.mp4 --use_adaptive

# 2. å›ºå®šæ’å¸§æ¨¡å¼ï¼ˆæ¯å¯¹å¸§ä¹‹é—´å›ºå®šæ’1å¸§ï¼‰
python client.py --video_path examples/0.mp4

# 3. è‡ªå®šä¹‰æœåŠ¡URL
python client.py --video_path examples/0.mp4 \
    --encoder_url http://192.168.1.100:8000/encode \
    --ditdec_url http://192.168.1.100:8001/interpolate

# 4. è‡ªå®šä¹‰è¾“å‡ºç›®å½•
python client.py --video_path examples/0.mp4 --output_dir custom_output
```

---

## ğŸ“ äº”ã€å…³é”®ä»£ç ä½ç½®

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | å‡½æ•°/ä»£ç è¡Œ |
|------|----------|------------|
| è¿åŠ¨åˆ†æ•°è®¡ç®— | `inference.py` | `compute_motion_scores()` (135-196è¡Œ) |
| æ·±åº¦åˆ¤æ–­é€»è¾‘ | `inference.py` | 321-333è¡Œ |
| é€’å½’æ’å¸§ | `inference.py` | `recursive_interp()` (199-223è¡Œ) |
| è§†é¢‘å¤„ç†ä¸»å¾ªç¯ | `inference.py` | 305-394è¡Œ |
| HTTPå®¢æˆ·ç«¯è¿åŠ¨è®¡ç®— | `client.py` | `compute_motion_scores()` (13-74è¡Œ) |
| HTTPå®¢æˆ·ç«¯è§†é¢‘å¤„ç† | `client.py` | `process_video()` (197-295è¡Œ) |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å•GPU vs åŒGPU**ï¼š
   - å•GPUæ¨¡å¼ï¼šæ¨¡å‹å…¨éƒ¨åœ¨ `cuda:0` ä¸Š
   - åŒGPUæ¨¡å¼ï¼šéœ€è¦è‡³å°‘2å¼ GPUï¼Œè‡ªåŠ¨æ£€æµ‹å¹¶å›é€€

2. **è‡ªé€‚åº”æ’å¸§**ï¼š
   - `inference.py`ï¼šå§‹ç»ˆä½¿ç”¨è‡ªé€‚åº”æ’å¸§ï¼ˆæ— æ³•å…³é—­ï¼‰
   - `client.py`ï¼šå¯é€šè¿‡ `--use_adaptive` å¼€å…³

3. **è¾“å‡ºfps**ï¼š
   - è‡ªåŠ¨è®¡ç®—ï¼š`fps_out = fps * (new_frames - 1) / (orig_frames - 1)`
   - ç›®çš„æ˜¯ä¿æŒè§†é¢‘æ€»æ—¶é•¿ä¸å˜

4. **é…ç½®æ–‡ä»¶**ï¼š
   - é»˜è®¤ä½¿ç”¨ `configs/eval_eden.yaml`
   - åŒ…å«æ¨¡å‹è·¯å¾„ã€å‚æ•°ç­‰é…ç½®

